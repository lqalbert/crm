<extend name="Common:base" />
<block name="head"></block>
<block name="body">
	<div id="app" class="container">
		<div class="wrapp" v-show="show" style="display: none">
			<!-- seach form -->
			<el-row>
				<el-col :span="12">
					<el-form :inline="true"   >
					  <el-form-item>
					    <el-input  placeholder="查询字段一" v-model="sousuo"></el-input>
					    </el-form-item><el-form-item>
					    <el-select  v-model="input" clearable placeholder="查询字段二">
					      <el-option label="区域一" value="区域一"></el-option>
					      <el-option label="区域二" value="区域二"></el-option>
					    </el-select>
					  </el-form-item>
					  <el-form-item>
					    <el-button icon="close"> 清空</el-button>
					    <el-button type="primary" icon="search" @click="sb(sousuo)">查询</el-button> 
			        	<el-button  @click="advancedSearch=true" icon="search">高级查询</el-button> 
					  </el-form-item>
					</el-form>
				</el-col>
				<el-col :span="12">
<!-- 				<div class="pull-right">
					删除之后  <el-button @click="reload">刷新</el-button> 一下
				</div> -->
					
				</el-col>	
			</el-row>
			<!-- / search form -->

			<!-- datatables  -->
			<el-row>
				<el-col :span="24">
					<el-table style="width: 100%" 
					:data="datalist" 
					border stripe height  
					v-loading.body="loading" 
					element-loading-text="拼命加载中">
					    <el-table-column type="selection"  align="center" width="50" >
					    </el-table-column>
					    <el-table-column label="序号"  align="center" width="65" :formatter="handleIndex"  >
					    </el-table-column>
					    <el-table-column label="单位ID" align="center" prop="id" width="80">
					    </el-table-column>
					    <el-table-column label="单位名" align="center" prop="name" width="120">
					    </el-table-column>
					    <el-table-column label="类型" align="center" prop="type">
					    </el-table-column>
						<el-table-column label="上级组织" align="center" prop="p_name" width="110">
					    </el-table-column>
					    <el-table-column label="片区" align="center" prop="zone">
					    </el-table-column>
					    <el-table-column label="联系人" align="center" prop="contact">
					    </el-table-column>
					    <el-table-column label="联系电话" align="center" prop="tel" width="140">
					    </el-table-column>
					    <el-table-column label="拓展一" align="center" prop="expand1">
					    </el-table-column>
					    <el-table-column  label="拓展二" align="center" prop="expand2">
					    </el-table-column>
					    <el-table-column  inline-template :context="_self"  align="center" label="形象照片" width="100">
					    	<el-tooltip content="点击放大图片" placement="right">
					    	 <img :src="imgUrl(row.img)" @click="bigImg(row.img)" alt="点击放大图片" width="45px" height="45px">
					    	<el-tooltip content="添加新的组织单位！" placement="right">	
					    </el-table-column>
                        <el-table-column label="地址" align="center" prop="address" width="180">
                        </el-table-column>
                        <el-table-column label="财务编号" align="center" prop="f_num" width="100">
                        </el-table-column>
                        <el-table-column label="是否公示" align="center" prop="public" width="100">
                        </el-table-column>
                        <el-table-column label="备注" align="center" prop="remark" width="100">
                        </el-table-column>

					    <el-table-column inline-template :context="_self"  fixed="right"  label="操作" width="140" align="center" >
					      <span>
					        <el-button @click="handleEdit($index, row)"    size="small">编辑</el-button>
					        <el-button @click="handleDelete($index, row)"  size="small" type="danger">删除</el-button>
					      </span>
					    </el-table-column>
				    </el-table>
				</el-col>
			</el-row>
			<!-- / datatables  -->
            

			<!-- toolbar -->
			<el-row type="type"  justify="space-between" align="middle"  class="row-bg">
			  <el-col :span="12">
			  <div class="grid-content bg-purple">
			  	<span class="wrapper">
			  		<el-tooltip content="添加新的组织单位！" placement="right">
					    <el-button size="small"  @click="dialogAdd = true" icon="plus" type="primary">添加</el-button>
					    <!-- <el-button  @click="">录入客户</el-button>
					    <el-button  @click="">修改客户</el-button> -->
					    <!-- <el-button>计划</el-button>
					    <el-button>推介</el-button> -->
				    </el-tooltip>
				</span>
			  </div>
			  </el-col>
			  <el-col :span="12">
				  <div class="grid-content bg-purple-light pull-right">
				    <!-- page -->
				    <include file="Common:_pagination" />
				    <!-- / page -->
				  </div>
			  </el-col>
			</el-row>
			<!-- / toolbar -->

		</div>

		<div v-show="show" style="display: none">
			<!-- 高级查询 -->
			<include file="_search" />
			<!-- / 高级查询 -->

			<!-- 添加 -->
			<include file="_add" />
			<!-- / 添加 -->

			<!-- 编辑 -->
			<include file="_edit" />
			<!-- / 编辑 -->


			<!-- bigimg -->
			<el-dialog  title="图片放大" :modal="false" size="small" v-model="bigimg" style="z-index:1000;">
			  <div style="margin:0;padding:0;text-align:center;z-index:1000;"><img :src="imageUrl" style="margin-left:-14px;width:850px;height:550px;"></div>
			</el-dialog>
            <!-- bigimg -->
		</div>


	</div>
</block>
<block name="scripts">
<script>
//   {$datalist | json_encode}
//
//
	var page ={
		dataList:{:json_encode($datalist)},
		addFormUrl:"{:U('add')}",
		editFormUrl:"{:U('edit')}",
		indexUrl:"{:U('index')}",
		deleteUrl:"{:U('delete')}",
		init:function(){
				this.dataList.forEach(function(currentValue, index){
					
					// currentValue['img']    = "__ROOT__/Upload/"+currentValue['img'];
				})
			}
	}
	page.init();
</script>
	<script>
		// vm option 里面的 data属性
		Oassign(window.vmData ,{
			loading: false,
			formLabelWidth: '140px',

			datalist:page.dataList,

			currentPage: 1,
			total:{$totalCount},
			pageSize:{$pageSize},

			//高级查询
			advancedSearch: false,
			//添加对话框
			dialogAdd: false,
			dialogEdit: false,
            //放大图片
            bigimg:false,
            //放大图片地址
            imageUrl:'',

			sousuo:'',
			input:'区域一',

			addForm :{
				name:"",
				public:"",
				type:"",
				p_name:"",
				zone:"",
				expand1:"",
				expand2:"",
				contact:"",
				tel:"",
				f_num:"",
				address:"",
				remark:"",
				img:""
			},
			addFormSubmit:false,

			editForm :{
				id:"",
				name:"",
				public:"",
				type:"",
				p_name:"",
				zone:"",
				expand1:"",
				expand2:"",
				contact:"",
				tel:"",
				f_num:"",
				address:"",
				remark:"",
				img:"",

			},
			editFormSubmit:false,
			//编辑默认显示的图片
			fileList:[
               {name: '', url: ''}
			],

			searchForm:{
				p:1,
				sortFiled:"id",
				sortWay:"asc" // desc
			},
			//表单验证
			rules:{
                 name:[
                    { required: true, message: '请填写单位名称', trigger: 'blur' },
                 ],
                 type:[
                    { required: true, message: '请选择类型', trigger: 'blur' },
                 ],
                 zone:[
                    { required: true, message: '请选择片区', trigger: 'blur' },
                 ],
                 contact:[
                    { required: true, message: '请填写联系人', trigger: 'blur' },
                 ],
                 tel:[
                    { required: true, message: '请填写联系电话', trigger: 'blur' },
                 ],
                 public:[
                    { required: true, message: '请选择是否公示', trigger: 'blur' },
                 ],
                 address:[
                    { required: true, message: '请填写地址', trigger: 'blur' },
                 ],
			}
            



		});

        //设置URL地址
		window.vmMethods.set('imgUrl', function(url){
			return "__ROOT__/Upload/department/"+url
		});
		window.vmMethods.set('bigImg', function(url){
			this.bigimg = true;
			this.imageUrl = "__ROOT__/Upload/department/"+url;
		})
        
        //处理添加图片上传回调的地址
		window.vmMethods.set('uploadImg', function(response, file, fileList){
			this.addForm.img = response.path;
			return response.path;
		})
        //处理编辑图片上传回调的地址
        window.vmMethods.set('uploadImg_E',function(response, file, fileList){
        	this.editForm.img = response.path;
        })
		//处理添加
		window.vmMethods.set("addFormAction", function(){
			var  vmThis = this;
	        this.$refs.addForm.validate(function(valid){
	          if (valid) {
				vmThis.addFormSubmit = true;
				vmThis.$http.post(page.addFormUrl, vmThis.addForm).then(function (response) {
					setTimeout(function(){
						vmThis.dialogAdd = false;
						vmThis.addFormSubmit = false;
						vmThis.loadDatalist();
						vmThis.$message({
						  message: '添加成功',
						  type: 'success'
						});
					}, 2000);
		        }, function(response){
	                setTimeout(function(){
	                  vmThis.addFormSubmit = false;	
					  vmThis.$message({
					    message: '添加失败',
					    type: 'error'
					  });
	                },2000);
		        });
	          }
	        });
		})

		//处理编辑
		window.vmMethods.set("handleEdit", function(index, row){
			//将此行数据赋给editForm
			this.initObject(this.editForm , row); 
			//设置显示的图片
			this.fileList = [{name:row.img, url: this.imgUrl(row.img)}];
			this.editIndex = index;
			this.dialogEdit = true;

		})

		window.vmMethods.set("editFormAction", function(){
			var  vmThis = this;
			this.editFormSubmit = true;
			this.$http.post(page.editFormUrl, this.editForm).then(function (response) {
				setTimeout(function(){
					vmThis.dialogEdit = false;
					vmThis.editFormSubmit = false;
					vmThis.initObject(vmThis.datalist[vmThis.editIndex], vmThis.editForm);  
					vmThis.$message({
						  message: '编辑成功',
						  type: 'success'
						});

				}, 2000);
	        }, function(response){
	        	setTimeout(function(){
	        		vmThis.editFormSubmit = false;
					vmThis.$message({
					  message: '编辑失败',
					  type: 'error'
					});
	        	},2000);
	        });
		})

		//处理删除
		window.vmMethods.set("handleDelete", function(index, row){
			var vmThis = this;
			this.$confirm('确定删除?', '提示', {
	          confirmButtonText: '确定',
	          cancelButtonText: '取消',
	          type: 'warning'
	        }).then(function(){
	        	vmThis.$http.post(page.deleteUrl, {ids:[row.id]}).then(function(response){
	        		vmThis.$message({
			            type: 'success',
			            message: '删除成功! '
			          });
	        		vmThis.datalist.splice(index, 1);
	        	}, function(response){
	        		vmThis.$message({
			            type: 'error',
			            message: '删除失败'
			          });
	        	})
	        }).catch(function() {
	          vmThis.$message({
	            type: 'info',
	            message: '已取消删除'
	          });          
	        });
		})

		//重载 数据列表
		window.vmMethods.set("reload", function(){
			this.loading = true;
			this.loadDatalist();
		})



		//处理分页
		window.vmMethods.set("handleCurrentPageChange", function(v){

			this.loading = true;
			this.searchForm.p = v;
			this.currentPage = v;
			this.loadDatalist();
		})

		//根据 查询条件 重载数据
		window.vmMethods.set("loadDatalist", function(){
			var vmThis = this;
			this.$http.get(page.indexUrl, {params: this.searchForm }).then(function(response){
				vmThis.$set(vmThis, 'loading', false);
				vmThis.$set(vmThis, 'datalist', response.body)
				// vmThis.$set(vmThis, 'total', 2);
			}, function(response) {
				vmThis.$message({
				  message: '获取失败',
				  type: 'error'
				});
				vmThis.$set(vmThis, 'loading', false);
			})
		})

		

	</script>
</block>