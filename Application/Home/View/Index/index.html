<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>CRM客户关系管理系统</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="format-detection" content="telephone=no">
		<link rel="stylesheet" href="__PUBLIC__/plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="__PUBLIC__/css/global.css" media="all">
		<link rel="stylesheet" href="__PUBLIC__/plugins/font-awesome/css/font-awesome.min.css">
		<link rel="stylesheet" href="__PUBLIC__/css/amaran.min.css">
		<style>
			.ui-pnotify {
				background: #fff;
			}
			.amaran .icon {
				background: #fff!important;
			}
			.amaran .icon img{
				max-width: 100px;
				max-height: 100px;
				display: block;
				margin: 0 auto;
			}
		</style>
		<script>
			window.webRoot = '__ROOT__/'; // /crm  
		</script>
	</head>
	<body>
		<div class="layui-layout layui-layout-admin">
			<div class="layui-header header header-demo">
				<div class="layui-main">
					<div class="admin-login-box">
						<a class="logo" style="left: 0;" href="#">
							<span style="font-size:22px;">CRM客户关系管理</span>
						</a>
						<div class="admin-side-toggle">
							<i class="fa fa-bars" aria-hidden="true"></i>
						</div>
					</div>
					<ul class="layui-nav admin-header-item" lay-filter="user">
						<li class="layui-nav-item">
							<a href="javascript:;">清除缓存</a>
						</li>
					  	<php>
							$userInfo = session('account')['userInfo'];
							$arr=M('group')->where(array('id'=>$userInfo['group_id']))->field('p_name,name')->find();
							$userInfo['p_name']=$arr['p_name'];
							$userInfo['name']=$arr['name'];
						</php>
						<li class="layui-nav-item">
							<a href="javascript:;" class="admin-header-user">
								<img src="__ROOT__{$userInfo['head']}" />
								<span><?php echo session('account')['account']?></span>
							</a>
							<dl class="layui-nav-child">
								<dd>
									<a data-tab="true" data-url='javascript:;'><i class="layui-icon">&#xe629;</i> <cite>个人信息</cite></a>
								</dd>
								<dd>
									<a data-tab="true" data-url='javascript:;'><i class="layui-icon">&#xe620;</i> <cite>设置</cite></a>
								</dd>
								<dd>
									<a href="{:U('Login/logOut')}"><i class="layui-icon">&#xe659;</i> <cite>注销</cite></a>
								</dd>
							</dl>
						</li>
					</ul>
				</div>
			</div>
			<div class="layui-side layui-bg-black" id="admin-side">
				<div class="layui-side-scroll" id="admin-navbar-side" lay-filter="side"></div>
			</div>
			<div class="layui-body" style="top: 57px;" id="admin-body">
				<div class="layui-tab admin-nav-card layui-tab-brief" lay-filter="admin-tab">
					<ul class="layui-tab-title">
						<li class="layui-this">
							<i class="layui-icon" aria-hidden="true">&#xe656;</i>
							<cite>我的工作台</cite>
						</li>
					</ul>
					<div class="layui-tab-content" style="min-height: 150px; padding:0;">
						<div class="layui-tab-item layui-show">
							<iframe src="{:U('Index/main')}"></iframe>
						</div>
					</div>
				</div>
			</div>
			<div class="site-tree-mobile layui-hide">
				<i class="layui-icon">&#xe602;</i>
			</div>
			<div class="site-mobile-shade"></div>
			<script type="text/javascript" src="__PUBLIC__/plugins/layui/layui.js"></script>

			<!-- <script type="text/javascript" src="__PUBLIC__/datas/nav.js" ></script> -->
			<script type="text/javascript" src="{:U('Nav/index')}" ></script>
			<script src="__PUBLIC__/js/index.js"></script>
			
		</div>
		<a href="" id="qqTrigger" style="display: none;"></a>
		<script src="__PUBLIC__/js/jquery.1.11.min.js"></script>
		<script src="__PUBLIC__/plugins/amaran/jquery.amaran.js"></script>
		<script>


			
		     var showList = {};
			 if (window.Notification && Notification.permission !== "granted") {
			    Notification.requestPermission(function (status) {
			      if (Notification.permission !== status) {
			        Notification.permission = status;

			      }
			    });
			  }
			  var trigger = document.getElementById("qqTrigger");


			  function notify(option, customer){

			  	option.icon="__PUBLIC__/images/0df431adcbef7609bca7d58a2adda3cc7cd99e73_r2_c2.jpg";
		
			  
			  	if (window.Notification) {
			  		option.icon="__PUBLIC__/images/0df431adcbef7609bca7d58a2adda3cc7cd99e73_r2_c2.jpg"
					var n = new Notification("您有一个即将到点计划",option);
					n.addEventListener('click', showQQ);
					n.customer = customer;
			  	} else {
			  		if (!showList[customer.qq]) {
			  			$.amaran({
					        'theme'     :'user no',
					        'content'   :{
					            img:'__PUBLIC__/images/0df431adcbef7609bca7d58a2adda3cc7cd99e73_r2_c2.jpg',
					            user:'您有一个即将到点计划',
					            message:option.body.replace("\n", "<br>")
					        },
					        'diyoption':  customer,
					        'position'  :'bottom right',
					        'outEffect' :'slideBottom',
					        'sticky'    :true,
					        onClick:function(){
					        	trigger.setAttribute('href', "tencent://message/?uin="+ this.diyoption.qq +"&Site=&menu=yes");
				  				trigger.click();
					        	myWorker.postMessage({type:"del", data:this.diyoption.qq});
					        	layui.jquery.post("{:U('Customer/setPlan')}", {id:this.diyoption.id});
					        	delete showList[this.diyoption.qq];
					        }
					    });
					    showList[customer.qq] = customer;
			  		}
			  		
			  	}
			  	
				
			  }

			  function showQQ(){
			  	trigger.setAttribute('href', "tencent://message/?uin="+ this.tag +"&Site=&menu=yes");
			  	trigger.click();
			  	this.close();

			  	myWorker.postMessage({type:"del", data:this.tag});
			  	layui.jquery.post("{:U('Customer/setPlan')}", {id:this.customer.id});
			  }

			  // var de = {body:"客户：比",tag:"837737931"};
			  // notify(de);

			  var myWorker = new Worker('__PUBLIC__/js/worker.js');
			  myWorker.onerror = function(e) { console.log(e); };
			  myWorker.onmessage = function(e) { 
			  	// console.log(e);
			  	var d = new Date();
			  	d.setTime(e.data.time);
			  	 notify({body:"客户："+e.data.name+"\n计划时间："+d.toLocaleString() + "\n" + e.data.remind, tag: e.data.qq }, e.data);
			  }
			  // myWorker.addEventListener('message', function(e){
			  // 	console.log(e);
			  // 	notify({body:"客户："+e.data.name, tag: e.data.qq }, e.data);
			  // })
			  myWorker.postMessage({type:"start", data:"{:U('Customer/getTodays')}"});


			  /*var n = new Notification("您有一个新计划",{icon:"__PUBLIC__/images/0df431adcbef7609bca7d58a2adda3cc7cd99e73_r2_c2.jpg",body:"客户：比",tag:"837737931"});
			  n.addEventListener("click", function(){
			  	trigger.setAttribute('href', "tencent://message/?uin="+ this.tag +"&Site=&menu=yes")
			  	// "tencent://message/?uin="+837737931+"&Site=&menu=yes";
			  	// var evt = document.createEvent("MouseEvents");    
	     //        evt.initEvent("click", true, true);    
	     //        trigger.dispatchEvent(evt);  
			  	// console.log(this.tag);
			  	trigger.click();

			  	this.close();
			  })*/
		</script>
	</body>

</html>