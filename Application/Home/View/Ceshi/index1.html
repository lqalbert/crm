<!-- <extend name="Common:base" /> -->
<block name="body">
<div id="app" class="container">
<div class="wrapp" id="appx" v-show="show" style="display: none;">
  <!-- <div class="a" style="border:1px solid red;"> -->
  <div class="a" id="app3">
  <el-row>
    <el-col :span="24">
      <el-form :inline="true" ref="searchForm" :model="searchForm">
        <el-form-item prop="name" style="width:170px">
          <el-input v-model="searchForm.name" size="small" placeholder="客户姓名"></el-input>
        </el-form-item>

        <el-form-item prop="contact" style="width:170px">
          <el-input v-model="searchForm.contact" size="small" placeholder="手机|qq|微信号"></el-input>
        </el-form-item>

        <el-form-item prop="group" style="width:80px">
          <el-select v-model="searchForm.group" size="small" placeholder="请选择">
            <el-option v-for="item in searchGroup" :label="item.key" :value="item.value" :disabled="item.disabled"></el-option>
          </el-select>
        </el-form-item>

        <el-form-item prop="field" v-show="false">
          <input type="hidden" size="small" v-model="searchForm.field">
        </el-form-item>

        <el-form-item>
          <el-button type="info" size="small" icon="search" @click="loadDatalist">查询</el-button> 
          
          <el-tooltip content="录入高级查询条件"  style="margin-left:10px;">
            <el-button  @click="openDialog('advancedQuery')" size="small" type="primary">{:L('ADVANCED_QUERY')}</el-button>
          </el-tooltip>

          <el-tooltip content="清空搜索框并刷新表格数据" placement="bottom-start" style="margin-left:10px;">
            <el-button  size="small" >重置</el-button>
          </el-tooltip>

          <el-tooltip content="录入新的客户" placement="bottom-start" style="margin-left:10px;">
            <el-button  @click="openDialog('add')" size="small" icon="plus" type="primary">{:L('ADD')}</el-button>
          </el-tooltip>

          <el-tooltip content="本人跟踪的客户" placement="bottom-start">
            <el-badge :value="{$aggregation.log}" :max="9" style="margin-left:10px;">
              <el-button type="info" size="small" @click="setField('log')">跟踪</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="本人没有跟踪的客户" placement="bottom-start">

            <el-badge :value="{$aggregation.unlog}" :max="9" style="margin-left:15px;">
              <el-button type="info" size="small" @click="setField('unlog')">未跟踪</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="本人计划跟踪的客户" placement="bottom-start">
            <el-badge :value="{$aggregation.plan}" :max="9" style="margin-left:15px;">
              <el-button type="info" size="small" @click="setField('plan')" >计划</el-button>
            </el-badge>
          </el-tooltip>

         <el-tooltip content="本人把客户转给他人的客户(分成)" placement="bottom-start">
            <el-badge :value="{$aggregation.transfto}" :max="9" style="margin-left:15px;">
              <el-button type="info" size="small" @click="setField('transfto')">转让</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="他人把客户转给本人的客户(分成)" placement="bottom-start">

            <el-badge :value="{$aggregation.transfin}" :max="9" style="margin-left:15px;">
              <el-button type="info" size="small" @click="setField('transfin')">转入</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="本人跟踪且成交了的客户" placement="bottom-start">
            <el-badge :value="{$aggregation.type}" :max="9" style="margin-left:15px;">
              <el-button type="primary" size="small" @click="setField('type')">服务</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="对客户进行筛选后重点跟踪" placement="bottom-start">
            <el-badge :value="{$aggregation.important}" :max="9" style="margin-left:15px;">
              <el-button type="info" size="small" @click="setField('important')">自选</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="他人的客户与您的客户有冲突" placement="bottom-start">
            <el-badge :value="{$aggregation.conflict}" :max="9" style="margin-left:15px;">
              <el-button size="small" type="warning" @click="setField('conflict')">冲突</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="导入我的客户" placement="bottom-start" style="margin-left:15px;">
            <el-button type="warning" size="small" @click="openDialog('importc')" :disabled="true">客户导入</el-button>
          </el-tooltip>

          <el-tooltip content="客户预查" placement="bottom-start"  style="margin-left:10px;">
            <el-button size="small"  @click="openDialog('preCheck')" type="primary">{:L('CUSTOMER_PRE_CHECK')}</el-button>
          </el-tooltip>

          <el-tooltip content="3个月内被索取数量" placement="right">
            <el-badge :value="{$pulled}" :max="9" style="margin-left:15px;">
              <el-button size="small" :disabled="true" @click="openDialog('exactsCon')" type="primary">{:L('EXACTS_CON')}</el-button>
            </el-badge>
          </el-tooltip>

          <el-tooltip content="点击刷新当前页面" placement="right"  style="margin-left:10px;">
            <el-button  size="small" type="danger">刷新</el-button>
          </el-tooltip>

        </el-form-item>
      </el-form>
      </el-col>
  </el-row>
  <!-- max-height="500" -->

  <el-row>
    <el-col :span="24">
      <el-table 
      :data="dataList" 
      border  
      id="he"
      v-loading="dataLoad" 
      element-loading-text="{:L('DATA_LOGIN')}"
      highlight-current-row
      empty-text="暂无数据,请录入客户！"
     
       ref="select" >

        <el-table-column width="50" align="center" type="selection"></el-table-column>

        <el-table-column label="{:L('INDEX')}"  :formatter="handleIndex" width="65"  ></el-table-column>
        <el-table-column  header-align="center" prop="name"  label="客户姓名" width="150"></el-table-column>
        <el-table-column  header-align="center" prop="type" label="客户类型" sortable width="170">
          <template scope="scope">
           
          </template>
        </el-table-column>

        <el-table-column  header-align="center"  prop="user_id" label="跟踪员工" sortable width="190">
            <template scope="scope">
            
            </template>
          </el-table-column>

          <el-table-column  header-align="center" prop="qq" label="QQ号"  width="170">
            <template scope="scope">
              {{ scope.row.qq }}
              <a v-if="scope.row.qq" :href="getTenct(scope.row.qq)">
                <img width="25"  src="__PUBLIC__/images/0df431adcbef7609bca7d58a2adda3cc7cd99e73_r2_c2.jpg" alt="">
              </a>
            </template>
          </el-table-column>

          <el-table-column  header-align="center" prop="qq_nickname" label="QQ昵称"  width="170"></el-table-column>

          <el-table-column prop="phone" label="手机" align="center" width="130"></el-table-column>

          <el-table-column  header-align="center" prop="weixin" label="微信号" align="left" width="170">
            <template scope="scope">
              {{ scope.row.weixin }}
            </template>
          </el-table-column>

          <el-table-column  header-align="center" prop="weixin_nickname" label="微信昵称" align="left" width="170">
            <template scope="scope">
              {{ scope.row.weixin_nickname }}
            </template>
          </el-table-column>

          <el-table-column  prop="last_track" sortable='customer' label="最后跟踪时间" align="center" width="175"></el-table-column>

        <el-table-column  prop="commission" label="跟踪方比例"  header-align="center" width="110"></el-table-column>
        <el-table-column  prop="plan" label="计划跟踪时间" align="center" width="175"></el-table-column>
        <el-table-column  prop="conflict" label="最后冲突时间" align="center" width="175"></el-table-column>
        <el-table-column  header-align="center"  label="地区" width="135">
          <template scope="scope">
            {{ scope.row.province_name+"-"+scope.row.city_name }}
          </template>
        </el-table-column>
        <el-table-column prop="sex"  label="性别" width="80"  header-align="center">
          <template scope="scope">
            
          </template>
        </el-table-column>
      </el-table>
    </el-col>
  </el-row>

  <!-- toolbar -->
  <el-row type="type"  justify="space-between" align="middle"  class="row-bg">

    <el-col :span="12" :offset="12">
      <div class="grid-content bg-purple-light pull-right">

        <!-- page -->
        <include file="Common:_pagination" />
        <!-- / page -->
        
      </div>
    </el-col>

  </el-row>
  </div>

  <div id="app2" class="b" style="margin:5px -10px 5px;">
      <div class="superaddition">
        <el-tooltip content="选择客户录入跟踪信息" placement="right">
          <el-button size="small" @click="openDialog('addTrack')" type="primary" style="margin-left:10px;">录入跟踪</el-button>
        </el-tooltip>

        <el-tooltip content="选择客户录入对其跟踪计划" placement="right">
          <el-button size="small" @click="openDialog('addPlan')" type="primary" style="margin-left:10px;">计划</el-button>
        </el-tooltip>

        <el-tooltip content="选择客户对其转让给他人(暂未实现)" placement="right">
          <el-button size="small" @click="openDialog('addTransfer')" :disabled="true" type="warning" style="margin-left:10px;">转让</el-button>
        </el-tooltip>

        <el-tooltip content="选择客户录入其提醒事项及内容" placement="right">
          <el-button size="small" @click="openDialog('addRemind')" type="info" style="margin-left:10px;">提醒</el-button>
        </el-tooltip>

        <el-tooltip content="筛选客户重点跟踪" placement="right">
          <el-button size="small" @click="openDialog('addChoice')" type="primary" style="margin-left:10px;">自选</el-button>
        </el-tooltip>
      </div>

    <el-row style="position: relative;top:-40px;">
     <el-col :span="24">
        <el-tabs  type="border-card">
          <el-tab-pane label="跟踪记录">
            <el-table :data="tableData"  empty-text="请点击客户显示跟踪信息" border style="width: 100%"  >
              <el-table-column prop="user" label="操作员工" header-align="center">
              </el-table-column>

              <el-table-column prop="type" label="客户类型" header-align="center">
              </el-table-column>

              <el-table-column prop="name" label="客户姓名" header-align="center">
              </el-table-column>
              
                <el-table-column label="内容" header-align="center">
                  <template scope="scope">
                    {{scope.row.content | handleString}}
                  </template>
                </el-table-column>

              <el-table-column prop="created_at" label="跟踪时间" width="180" align="center">
              </el-table-column>

              <el-table-column prop="track_text" label="跟踪类型" header-align="center">
              </el-table-column>

            </el-table>
          </el-tab-pane>

          <!-- <el-tab-pane label="软件账号">软件账号</el-tab-pane>
          <el-tab-pane label="通话记录">通话记录</el-tab-pane> -->
          <el-tab-pane label="客户资料">客户资料</el-tab-pane>
        </el-tabs>
     </el-col>
    </el-row>
  </div>

</div>

<div class="dialogWrapper" v-show="show" style="display: none">

  <!-- 录入客户 -->
  <include file="_add" />
  <!-- / 录入客户 -->
  
</div>

</div>
</block>
<block name="scripts">
<script>
  //表单验证
  var checkPhone=function(rule,value,callback){
     var phoneReg = /^1[34578]\d{9}$/;
     if(value==='' || value===null){
       callback();
     }else if(!phoneReg.test(value)){
       callback('手机号格式错误');
     }else{
       callback();
     }
  }
  var checkQQ=function(rule,value,callback){
    var number=/^\d+$/;
    if(value==='' || value===null){
      callback();
    }else if(!number.test(value)){
      callback('QQ号格式错误');
    }else{
      callback();
    }
  }
  var checkIdNum=function(rule,value,callback){
    var number=/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
    if(!number.test(value)){
      callback('身份证号格式错误');
    }else{
      callback();
    }
  }

  window.defaultOption.setDatas({
    customerType:{:json_encode($customerType)},
    sexType:{:json_encode($sexType)},
    Quality:{:json_encode($Quality)},
    Year:{:json_encode($Year)},
    Income:{:json_encode($Income)},
    Sty:{:json_encode($Sty)},
    Money:{:json_encode($Money)},
    Energy:{:json_encode($Energy)},
    Problem:{:json_encode($Problem)},
    Mode:{:json_encode($Mode)},
    Attitude:{:json_encode($Attitude)},
    Profession:{:json_encode($Profession)},
    Intention:{:json_encode($Intention)},
    Source:{:json_encode($Source)},
    Proportion:{:json_encode($Proportion)},
    Remind:{:json_encode($Remind)},
    GoodsType:{:json_encode($GoodsType)},
    logType:{:json_encode($logType)},
    steps:{:json_encode($steps)},
    searchGroup:{:json_encode($searchGroup)},
    memberList:{:json_encode($memberList)},

    addRules:{
      name:[
        { required: true, message: '请输入客户姓名', trigger: 'blur' },
        
      ],
      phone:[
        { required: true, message: '请输入客户手机', trigger: 'blur' },
        //{ type: 'number', message: '手机必须为数字'},
        { validator: checkPhone, trigger: 'blur' }
      ],
      phone2:[
        { validator: checkPhone, trigger: 'blur' }
      ],
      qq:[
        //{ type: 'number', message: 'QQ号必须为数字'},
        { validator: checkQQ, trigger:'blur' },
      ],
      qq2:[
        { validator: checkQQ, trigger:'blur' },
      ],
      type:[
        { required:true, message:'请选择客户类型',trigger:'blur'},
      ],
      money:[
        { required:true, message:'请选择客户资料量',trigger:'blur'},  
      ],
    },

  }).setForm('search', {
    name:'',
    contact:'',
    field: '',
    group:'user_id',
    ctrl:'search',
  }).setForm('add',{
    name:"",
    type:"C",
    phone:'',
    phone2:"",
    qq:'',
    qq2:"",
    qq_nickname:"",
    qq_nickname2:"",
    sex:0,
    weixin:null,
    weixin_nickname:"",
    area_province:null,
    area_city:null,
    quality:'',
    year:'',
    re_income:'',
    style:'',
    money:'',
    energy:'',
    problem:'',
    mode:'',
    attitude:'',
    profession:'',
    intention:'',
    source:'',
    remark:"",
  }).setMethod('beforeList', function(data){
        
        data.forEach(function(currentValue){
          //将string类型转换为number和为0的变为空
          currentValue.quality = currentValue.quality == 0?"":currentValue.quality;      
          currentValue.year = currentValue.year == 0?"":currentValue.year;      
          currentValue.re_income = currentValue.re_income == 0?"":currentValue.re_income;      
          currentValue.style = currentValue.style == 0?"":currentValue.style;      
          currentValue.money = currentValue.money == 0?"":currentValue.money;      
          currentValue.energy = currentValue.energy == 0?"":currentValue.energy;      
          currentValue.problem = currentValue.problem == 0?"":currentValue.problem;      
          currentValue.mode = currentValue.mode == 0?"":currentValue.mode;      
          currentValue.attitude = currentValue.attitude == 0?"":currentValue.attitude;      
          currentValue.profession = currentValue.profession == 0?"":currentValue.profession;      
          currentValue.intention = currentValue.intention == 0?"":currentValue.intention;      
          currentValue.source = currentValue.source == 0?"":currentValue.source; 


       })
     return data;
  }).setMethod('provinceChange', function(v){
    var vmThis = this;
    this.$http.get('{:U("Area/getAreasByPid")}', {params:{pid:v} }).then(function(response){
      var cities = [];
       response.body.forEach(function(currentValue,index){
        cities.push({id: currentValue.id, name: currentValue.name});
       })
       vmThis.$set(vmThis, 'cities', cities);
    });
  }).setMethod('addSubmit',function(url, form){
    FormName.type = form;
    var  formName    =  FormName.getFormName(); 
    if(this[formName].type=='V'){
       this.realInfoFormDialog=true;
       this.realInfoForm.fm = 'add'; 
    }else{ 
       this.addFormSubmit(url, form);
    } 
  });
</script>
</block>